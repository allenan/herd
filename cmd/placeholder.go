package cmd

import (
	"fmt"
	"os"
	"os/signal"
	"strings"
	"syscall"

	"github.com/spf13/cobra"
	"golang.org/x/term"
)

// Art sizes: LG 98x58, SM 57x33, XS 41x24
// Minimum viewport with padding (4h per side, 2v per side, 3 lines below for label+hint):
//   LG: 106x63, SM: 65x38, XS: 49x31

const padH = 4 // horizontal padding per side
const padV = 2 // vertical padding per side
const labelLines = 3 // "herd" label + blank + hint line below art

// artLG is 98x58
const artLG = `                         ::                                            ::
                   .+**=:  *#+.-*.                               ++ :##= .-+**:
                :*%%%%%%%%%%%%%###=-:                         +-#%*%%%%%%###%%%%#-
           .=#%%%#**######%%%%%%%%%%#:                       =#%%%%%%%%######****#%%%+:
    -#%%#####*+++=+#%%%%%%%%%%%%%%####=.:+*#%%%#*+==*####*+:-#%%##%%%%%%%%%%%##+++***##%%%%%%=
  .#%#*******+++*###%%#%%%%%%%%%%%%#++###*++++++*****+++++*###*+*%%%%%%%%%%%#%%%%#++********###-
  *%********++*%%%#+++++++*%%%%#***##*++++++++=:=+++=--++++++++*#####%%%%%##*++*%%%#++********#*
 .*#*******+#%%%**#%%#*++#%%%%%%%%#+++++++++++-.  -:   -+++++++++###%%%%%%%%%%%%##%%%#++******#%:
 -##*****+*%%%%%%%%%%%%%%#%%%%#*+++++++++++++=-         =+++++++++++++##%%%%%%%%%%%%%%%*=+****#%-
 +%#***=+#%%%%%%%%%%%%%%%%%###+++++++++++++++=          :++++++++*#####**#%%%%%%%%%%%%%##*++**#%+
:#%##*###++#%%%%%%%%%%%%%%%*+++*###++++++++++-=         -=+++++++++#%%%%%%%%%%%%%%%%%%##-###**##%:
+%%%%%*:    *##%%%%%%%%%%%#+*##%#*+++++++++++=.         .=++++++++++#%%%#%%%%%%%%%%%%#+    =#%%%%=
 ..        *%%%%%%%%%%%##*+*%%%%##**++++++++++=         -==++++++*****%%#**#%%%%%%%%%%#-       ..
           :#%%%%%%%##**++*%%%%%%%#*+++++++++++=       :+++***+++++*#%%%%#+++**#%%%%%%#
          .#***#%%%%%#*++##%%%%%%%%#*+**######+=       +*#%%%#*+++*#%%%%%%#++*#%%%%%*=+*
              +%%%%%#*+*#%%%%%%##*+++**#%%%%%%*=.     .*%%%%%%#**+++*#%%%%%#*+*#%%%%*.
            :*--*%#*##*%%%%%%%##++++*##%%%%%%%#+-     :*%%%%%%%##*+++*%%%%%%#****##-:+=
               *%#%%#*%%%%%%%%#**+++***##%%%%%%*=     :*%%%%%#####****#%%%%%%#*#%#%%.
              +%%%%%##%%%%%%%%%%###*-+=:+#%%%%%*:      +#%%%%#.-* *##%%%%%%%%%##%%%##
             .#+-*%%%%%%%%%%%%%%##**: -=.*%%%%*=       -*%%%%:-=. #*#%%%%%%%%%%%%#:+#+
             -- -*#%%%%%%%%%%%%%#**+***####%#*=.        -+#%#####**###%%%%%%%%%%%*+ .#
                 -#%%%%%%%%%%%%%%%#*+++++++*+=:          :=**++++++*%%%%%%%%%%%%%*
                :#%%%%%%%%%%%%%%%%%#*++++++=-             .=++*##%%%%%%%%%%%%%%%%%=
               -%%%%%%##%%%%%%%%%%%%%%%*+++-                -+*#%%%%%%%%%%%%##%%%%%*
              #%%%%%#*#%%%%%%%%%%%%%%%#*#*-                 .+**%%%%%%%%%%%%%*#%%%%%%=
           :--:-#%%#*##%%%%%%%%%%%%%%%##+:                    =#%%%%%%%%%%%%##**%%%+ .:.
              *%%%#***#%%%%%%%%%%%%%%%%*-                      =#%%%%%%%%%%%%*++*#%%#-
              =%#*****#%%%%%%%%%%%%%%%#*.                      -#%%%%%%%%%%%%%*+++*%#.
             :##*##**#%%%%%%%%%%%%%%%%%=        =+++++++-       #%%%%%%%%%%%%%#**#**##
            :%####*+**##%%%%%%%%%%%%%%%:      **=:     .-*=     *%%%%%%%%%%%#*+++*###%#
            #%%%%*+**#**##%%%%%%%%%%%%#      .#+*********##     :%%%%%%%%%##**++++#%%%%=
           -%*+%###%%%%%%%%%%%%%%%%%%%*       %%%#*%%%#%%%*      #%%%%%%%%%%%%%##*#%#*%#
           =+.+%%%%%%%#%%%%%%%%%%%%%%%*       .*#**%%%****.      #%%%%%%%%%%%%%%%%#%%.=#
           :  *%%%%%*:+#%%%*-.     :+#%.       .+#%%%%%#+.      :#*:    :=#%%##%%%%%%- =
              *%%%#=  *%%*.          -#*           :=:          #+         -#*:=#%%%#=
              *%%#-   #%-             .*#-       ..-=-.       :#*            =: +%%%%=
             -%%%=    *-                :*##*+*#*######****###*:                =#**%:
            :%%%#: .  .                    .*#-.        .=#*.                   :#* *
           :%%%%#:.=                          =####**####+.                     -##
          +##%%%#-=#.                                                        -: =%*
           :%%%%#*#%+    .                                        ..        .*=:*#=
          :%%%%####%%-   +                                         %-       -###%%:
         .#%%%##***###: .#=        -#.    :-    -#:   .  :=.      .%%.    .:*%%%%%-
         %%%%#**#****##=:%%-      .#%*-+=  +%*-  #%#*=+##*###+  #-+%#*  .=+*%%%%%%+
        #%%%%####****#%%#%%%=     =####%%%%%#-:::::::::::::=#%%#%#*+##. +%%*+++#%%#
       :%%%%%%%%#***####%%#=#+-: .*#***+**#%-::::.:::--..:::*%*#**++##+*##=   .+%%%=
       *%%%%%%%%#####***=*#-.*##=-%%##*+--*#-..:=++...++-:.:+#=--*#%%%%%*.     =#%%#.
       %%%%%%%%%%####***: .=  -#%%%##%##++*#-:-=+-=+:+=--..:=#**##*-*%*:    .: -#%++#.
      =%%%%%%%%%%####***:       :*%*. .-+*##-:--:=:-:-:---::+#+-.  .=.      .*+-#%*  .
      %%%%%%%%%%%###%#**=         .=.      +#*++++++=+=++++*#.              .*%%%%%:
     -%%%%%%%%%%%%%%%%##*  -                ..:::..........                 .*%%%%%+
     +%#***#%%%%%%%%%%%#*- *+                                           ..  -#%%%%%*
             :+#%%%%%%%%#*:**-                                          :+ .*%%#*:
                .+#%%%%%%#**#*=                                         -*=+%#-
                   :*#%%%%%####+                                        :%%#=
                      -#%%%%%#-==.                                      :#+
                         .*#%#=                                         :-
                              :`

// artSM is 57x33
const artSM = `               -  .                      .:
          +#%%%%%%*#.               :-##%##%%%#-
    =*###***#%%%%%%%%%.             %%%%%%%%%*+**###*-
 .%#****=*###*#%%%%%%***+++++*+++++***%%%%%#*#%#*+****##
 +#***+#%#*##*+%%%%%*++++++: -  -+++++##%%%%%%%#%%+****#.
 %**++%%%%%%%%%%#+++++++++=      ++++++++*#%%%%%%%%#+**#-
=%#%%.-#%%%%%%%#+*##++++++=.     :+++++*%%%%%%%%%%#.-%##%
      -%%%%%%%*+#%%##++++++-     =++++*#*%#*#%%%%%%.
      -##%%%#*+#%%%%#*+*##*+    +*#%*++#%%%#+##%%**-
        #=%***%%%%#++*#%%%%*.   *%%%%#*+*%%%%**%**.
         %%%*%%%%#**+####%%#-   *%%####*%#%%%##%%=
        #:#%%%%%%%%#*:::#%%+    :#%%:::*%%%%%%%#.#
         -+%%%%%%%%%*++++#+      :+*+++*%%%%%%%*
         -%%%#%%%%%%%##*+=         +*%%%%%%%%#%%*
        ##%%*%%%%%%%%%##+           *#%%%%%%%*#%#%:
        +%%**#%%%%%%%%%=             *%%%%%%%*+#%#
        *#*##%%%%%%%%%%-     .:.     =%%%%%%%%**+%
       +%%*+*###%%%%%%%    *=::::++   %%%%%%#+++%%%
       %-%#%%%%%%%%%%%#    %%*%#%%=   %%%%%%%%%####:
        +%%%+*%%#.  :#%     #%%%%=    %+  -#%#%%%% .
        *%%. %*       -#      .      *.      *.%%%
        %%.  +          :##=-===--##:          *+%
       %%%.=               +##*##+             *=
      .#%%+%.                                *.#:
      #%%####  :     -      -          %    .%%%
     *%%*#**##-%:   +%+# =%-.##+####=-+## :+%%%%-
    .%%%%%**##%#*=: #****%::::.-:.:*##*+#+#+  +%#
    *%%%%%##**:=.:%#%%#+-#:--*.+-:.+*=#%%%.   -##*
    %%%%%%###*:    :#. .-#-=-:.:--:*-  .     #+%*
   =%%%%%%%%%#* :                            #%%#
   .    %%%%%%#:*.                        : :%%*
           *%%%###:                       -*%.
              #%%* =                      -=`

// artXS is 41x24
const artXS = `        ++-+-+             :++-*-
  .:=##*#%%%%%%-         =%%%%%#**#*-:
.#****##**#%%#**+++=++-+++*#%%%####****+
-***#%%%%%%#*+++++=    -+++++*%%%%%%***#
*#*:=#%%%%#*##++++=    :++++#%%%%%%#.-*#-
    -%%%#**#%%*++++:   =**+*#%#*#%%%
     =*#**%%%*+#%%%+  .#%%#**%%#*##-
      %%#%%%##*++%%*   #%#=*#%%%#%#
     :.*%%%%%#*==#*.   -#+=*#%%%%#:.
      :%%#%%%%%#*+       +#%%%%#%#:
     =+%#%%%%%%%*        .#%%%%%*%*=
     -#**%%%%%%%:         -%%%%%#*#-
     ##**##%%%%%   ++==*.  #%%%#++#%
    ::%%%%%%%%%#   -*%#*   #%%%%%%%=-
     .%+ %-    :-    :.   -    -:#%:
     *#: .       :+=:::=*:       -+
    +##+.                       -=.
    *%##* :         .      :-  -%#
   =%##*###=  +*#+*--=-==#**#.**+%:
   #%%%##*=-++%#=+=:+:-:.*+#%#.  #*
  -%%%%##*.   =  -+=-:---=      %#-
  +=+#%%%#=:                   :%#-
       -#%##+                 =*
          =#:                 .`

type artOption struct {
	art    string
	width  int
	height int
}

var artSizes = []artOption{
	{artLG, 98, 58},
	{artSM, 57, 33},
	{artXS, 41, 24},
}

var placeholderCmd = &cobra.Command{
	Use:    "placeholder",
	Short:  "Show viewport placeholder (internal)",
	Hidden: true,
	Run:    runPlaceholder,
}

func init() {
	rootCmd.AddCommand(placeholderCmd)
}

func runPlaceholder(cmd *cobra.Command, args []string) {
	// Hide cursor
	fmt.Print("\033[?25l")

	render()

	// Re-render on terminal resize
	sigCh := make(chan os.Signal, 1)
	signal.Notify(sigCh, syscall.SIGWINCH)
	for range sigCh {
		render()
	}
}

func render() {
	w, h, err := term.GetSize(int(os.Stdout.Fd()))
	if err != nil {
		w, h = 80, 24
	}

	// Clear screen and move cursor home
	fmt.Print("\033[2J\033[H")

	// ANSI color codes
	const (
		colorArt   = "\033[38;5;240m"
		colorLabel = "\033[1;38;5;243m"
		colorHint  = "\033[38;5;245m"
		reset      = "\033[0m"
	)

	// Select the largest art that fits
	var selected *artOption
	for i := range artSizes {
		a := &artSizes[i]
		needW := a.width + padH*2
		needH := a.height + padV*2 + labelLines
		if w >= needW && h >= needH {
			selected = a
			break
		}
	}

	if selected == nil {
		// Text-only fallback
		renderTextOnly(w, h, colorLabel, colorHint, reset)
		return
	}

	artLines := strings.Split(selected.art, "\n")
	totalH := selected.height + labelLines // art + blank + "herd" + hint
	topPad := (h - totalH) / 2
	if topPad < 0 {
		topPad = 0
	}

	var buf strings.Builder

	// Top padding
	for i := 0; i < topPad; i++ {
		buf.WriteByte('\n')
	}

	// Art lines (centered)
	for _, line := range artLines {
		leftPad := (w - selected.width) / 2
		if leftPad < 0 {
			leftPad = 0
		}
		buf.WriteString(colorArt)
		for i := 0; i < leftPad; i++ {
			buf.WriteByte(' ')
		}
		buf.WriteString(line)
		buf.WriteString(reset)
		buf.WriteByte('\n')
	}

	// Blank line between art and label
	buf.WriteByte('\n')

	// "herd" label (centered)
	label := "herd"
	labelPad := (w - len(label)) / 2
	if labelPad < 0 {
		labelPad = 0
	}
	for i := 0; i < labelPad; i++ {
		buf.WriteByte(' ')
	}
	buf.WriteString(colorLabel)
	buf.WriteString(label)
	buf.WriteString(reset)
	buf.WriteByte('\n')

	// Hint line (centered)
	hint := "Press n to create a session"
	hintPad := (w - len(hint)) / 2
	if hintPad < 0 {
		hintPad = 0
	}
	for i := 0; i < hintPad; i++ {
		buf.WriteByte(' ')
	}
	buf.WriteString(colorHint)
	buf.WriteString(hint)
	buf.WriteString(reset)

	fmt.Print(buf.String())
}

func renderTextOnly(w, h int, colorLabel, colorHint, reset string) {
	label := "herd"
	hint := "Press n to create a session"

	totalH := 3 // label + blank + hint
	topPad := (h - totalH) / 2
	if topPad < 0 {
		topPad = 0
	}

	var buf strings.Builder

	for i := 0; i < topPad; i++ {
		buf.WriteByte('\n')
	}

	labelPad := (w - len(label)) / 2
	if labelPad < 0 {
		labelPad = 0
	}
	for i := 0; i < labelPad; i++ {
		buf.WriteByte(' ')
	}
	buf.WriteString(colorLabel)
	buf.WriteString(label)
	buf.WriteString(reset)
	buf.WriteByte('\n')
	buf.WriteByte('\n')

	hintPad := (w - len(hint)) / 2
	if hintPad < 0 {
		hintPad = 0
	}
	for i := 0; i < hintPad; i++ {
		buf.WriteByte(' ')
	}
	buf.WriteString(colorHint)
	buf.WriteString(hint)
	buf.WriteString(reset)

	fmt.Print(buf.String())
}
